// Generated by CoffeeScript 1.10.0
var NotificationHelper, User, localization, notificationHelper, otpManager, passport, passwordKeys, qs, url,
  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

passport = require('passport');

qs = require('querystring');

NotificationHelper = require('cozy-notifications-helper');

notificationHelper = new NotificationHelper;

localization = require('../lib/localization_manager');

passwordKeys = require('../lib/password_keys');

otpManager = require('../lib/2fa_manager');

url = require('url');

User = require('../models/user');

module.exports.authenticate = function(req, res, next) {
  var authSuccess, postLogin, process, processOtp;
  process = function(err, user) {
    var error;
    if (err) {
      error = new Error('error server');
      return next(error);
    } else if (user === void 0 || !user) {
      error = new Error('error bad credentials');
      error.status = 401;
      return next(error);
    } else {
      return passwordKeys.initializeKeys(req.body.password, function(err) {
        if (err) {
          error = new Error('error keys not intialized');
          return next(error);
        } else {
          return postLogin(user);
        }
      });
    }
  };
  postLogin = function(user) {
    return otpManager.getAuthType(function(err, otpAuth) {
      var error;
      if (err) {
        error = new Error('error login failed');
        error.status = 401;
        return next(error);
      } else if (!otpAuth) {
        return req.logIn(user, function(err, info) {
          if (err) {
            error = new Error('error login failed');
            error.status = 401;
            return next(error);
          } else {
            return res.status(200).send({
              success: true
            });
          }
        });
      } else {
        return passport.authenticate(otpAuth, processOtp)(req, res, next);
      }
    });
  };
  processOtp = function(err, user) {
    var error, msg;
    if (err) {
      error = new Error(err);
      return next(error);
    } else if (!user && user !== void 0) {
      msg = new Error('error otp invalid code');
      return User.first(function(err, user) {
        var index, recoveryCodes, ref;
        recoveryCodes = user.encryptedRecoveryCodes[0];
        if (ref = parseInt(req.body.authcode), indexOf.call(recoveryCodes, ref) >= 0) {
          index = recoveryCodes.indexOf(parseInt(req.body.authcode));
          recoveryCodes.splice(index, 1);
          return user.updateAttributes({
            encryptedRecoveryCodes: recoveryCodes
          }, function() {
            var str;
            str = localization.t("authenticated with recovery code");
            str += recoveryCodes.length + " ";
            str += localization.t("recovery codes left");
            return notificationHelper.createTemporary({
              text: str
            }, function() {
              if (recoveryCodes.length === 0) {
                str = localization.t("recovery codes warning");
                notificationHelper.createTemporary({
                  text: str
                });
              }
              return authSuccess();
            });
          });
        } else {
          error = new Error(msg);
          error.status = 401;
          return next(error);
        }
      });
    } else {
      return authSuccess();
    }
  };
  authSuccess = function() {
    return User.first(function(err, user) {
      return req.logIn(user, function(err, info) {
        var error, msg;
        if (err) {
          msg = new Error('error login failed');
          error = new Error(msg);
          error.status = 401;
          return next(error);
        } else {
          return res.status(200).send({
            success: true
          });
        }
      });
    });
  };
  return passport.authenticate('local', process)(req, res, next);
};

module.exports.isAuthenticated = function(req, res, next) {
  if (req.isAuthenticated()) {
    return next();
  } else {
    url = "/login";
    if (req.url !== '/') {
      url += "?next=" + (encodeURIComponent(req.url));
    }
    if (req.query.length) {
      url += "&" + (qs.stringify(req.query));
    }
    return res.redirect(url);
  }
};

module.exports.isNotAuthenticated = function(req, res, next) {
  if (req.isAuthenticated()) {
    return res.redirect('/');
  } else {
    return next();
  }
};
